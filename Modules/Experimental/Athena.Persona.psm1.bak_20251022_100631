# ====================================================================
# üí¨ Athena.Persona.psm1 ‚Äì Adaptation linguistique & √©motionnelle
# Version : v1.2-Stable-Robust (auto-r√©paration + ton adaptatif s√©curis√©)
# Description : Ajuste le ton et le style de la r√©ponse selon le profil linguistique de l‚Äôutilisateur.
# ====================================================================

Set-StrictMode -Version Latest
$ErrorActionPreference = "SilentlyContinue"

$ModuleDir   = Split-Path -Parent $MyInvocation.MyCommand.Path
$RootDir     = Split-Path -Parent $ModuleDir
$MemoryDir   = Join-Path $RootDir "Memory"
$ProfileFile = Join-Path $MemoryDir "Profile.Linguistic.json"

# ====================================================================
# üìÅ Initialisation du profil linguistique (auto-r√©paration)
# ====================================================================
function Initialize-AthenaLinguisticProfile {
    if (!(Test-Path $ProfileFile)) {
        $DefaultProfile = @{
            AverageLength = 40
            Emotion       = 0.3
            DominantType  = "neutre"
            PreferredTone = "calme"
        }
        $DefaultProfile | ConvertTo-Json -Depth 3 | Set-Content -Path $ProfileFile -Encoding UTF8
        Write-Host "ü©π Profil linguistique par d√©faut cr√©√©." -ForegroundColor DarkCyan
    }
}

Initialize-AthenaLinguisticProfile

# ====================================================================
# üìñ Lecture du profil linguistique
# ====================================================================
function Get-AthenaLinguisticProfile {
    try {
        $json = Get-Content $ProfileFile -Raw -ErrorAction Stop
        if ([string]::IsNullOrWhiteSpace($json)) { throw "Fichier vide." }
        return ($json | ConvertFrom-Json -ErrorAction Stop)
    }
    catch {
        $errMsg = if ($_.Exception) { $_.Exception.Message } else { "Erreur inconnue durant la lecture du profil linguistique." }
        Write-Warning "‚ö†Ô∏è Erreur lecture profil linguistique : $errMsg"
        # Auto-r√©paration du profil
        Remove-Item $ProfileFile -ErrorAction SilentlyContinue
        Initialize-AthenaLinguisticProfile
        return (Get-Content $ProfileFile -Raw | ConvertFrom-Json)
    }
}

# ====================================================================
# üí° Fonction principale ‚Äì Adaptation du ton
# ====================================================================
function Invoke-AthenaPersona {
    param([string]$Prompt)

    $Profile = Get-AthenaLinguisticProfile
    if (-not $Profile) {
        Write-Warning "‚ö†Ô∏è Profil linguistique non charg√©, utilisation du ton neutre."
        $Profile = @{ PreferredTone = "neutre" }
    }

    switch ($Profile.PreferredTone) {
        "calme" {
            $prefix = "R√©ponds avec douceur, empathie et clart√©. "
        }
        "directif" {
            $prefix = "R√©ponds de mani√®re concise, efficace et orient√©e action. "
        }
        "curieux" {
            $prefix = "R√©ponds avec curiosit√©, p√©dagogie et clart√© d‚Äôexplication. "
        }
        "√©motionnel" {
            $prefix = "R√©ponds avec chaleur, √©motion et bienveillance. "
        }
        "analytique" {
            $prefix = "R√©ponds de fa√ßon structur√©e et logique, en expliquant le raisonnement. "
        }
        default {
            $prefix = "R√©ponds de fa√ßon naturelle et claire. "
        }
    }

    $PromptAdapted = "$prefix Voici la requ√™te : $Prompt"
    Write-Host "üí¨ [Persona] Ton appliqu√© : $($Profile.PreferredTone)" -ForegroundColor Green
    return $PromptAdapted
}

# ====================================================================
# üì§ Export des fonctions
# ====================================================================
Export-ModuleMember -Function Invoke-AthenaPersona, Get-AthenaLinguisticProfile
Write-Host "‚úÖ Athena.Persona.psm1 charg√© (v1.2-Stable-Robust ‚Äì Adaptation linguistique op√©rationnelle)." -ForegroundColor Cyan


















































