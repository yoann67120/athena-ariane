# =====================================================================
# üß† Athena.Cognition.psm1 ‚Äì Phase 15 : Expansion Cognitive & M√©tacognition
# v1.2-stable ‚Äì Compatibilit√© PowerShell 5.x / 7.x + correctif CognitiveMap
# =====================================================================
# Objectif :
#   Observer ‚Üí R√©fl√©chir ‚Üí Conclure ‚Üí M√©moriser ‚Üí Ajuster
#   Donne √† Athena la capacit√© de raisonner sur ses exp√©riences,
#   de d√©tecter des motifs et d‚Äôen tirer des enseignements persistants.
# =====================================================================

Set-StrictMode -Version Latest
$ErrorActionPreference = "SilentlyContinue"

# --- Dossiers principaux ---
$ModuleDir     = Split-Path -Parent $MyInvocation.MyCommand.Path
$RootDir       = Split-Path -Parent $ModuleDir
$LogsDir       = Join-Path $RootDir "Logs"
$MemoryDir     = Join-Path $RootDir "Memory"
$CognitionLog  = Join-Path $LogsDir   "Athena.CognitiveReport.log"
$CognitiveMap  = Join-Path $MemoryDir "CognitiveMap.json"

# =====================================================================
# üîπ UTILITAIRES DE LOG
# =====================================================================
function Write-CognitionLog {
    param([string]$Message, [string]$Level = "INFO")
    $t = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
    $entry = "[$t][$Level] $Message"
    Add-Content -Path $CognitionLog -Value $entry
    Write-Host "üß† $Message" -ForegroundColor Cyan
}

# =====================================================================
# üîπ INITIALISATION
# =====================================================================
function Initialize-Cognition {
    Write-CognitionLog "Initialisation du moteur cognitif..."
    $deps = @("LocalModel","ActionEngine")
    foreach ($dep in $deps) {
        if (-not (Get-Module -Name $dep)) {
            $path = Join-Path (Join-Path $RootDir "Modules") "$dep.psm1"
            if (Test-Path $path) {
                Import-Module $path -Force -Global
                Write-CognitionLog "‚úÖ D√©pendance charg√©e : $dep"
            }
            else {
                Write-CognitionLog "‚ö†Ô∏è D√©pendance manquante : $dep" "WARN"
            }
        }
    }
    if (!(Test-Path $MemoryDir)) { New-Item -ItemType Directory -Path $MemoryDir -Force | Out-Null }
    if (!(Test-Path $LogsDir))   { New-Item -ItemType Directory -Path $LogsDir   -Force | Out-Null }
    Write-CognitionLog "Moteur cognitif initialis√© avec succ√®s."
}

# =====================================================================
# üîπ COLLECTE DES DONN√âES ET OBSERVATIONS (compatibilit√© universelle)
# =====================================================================
function Collect-AthenaState {
    Write-CognitionLog "Collecte des donn√©es syst√®me et logs..."
    # -- Mesures universelles via WMI/CIM --
    try {
        $cpuLoad = (Get-CimInstance Win32_Processor | Measure-Object -Property LoadPercentage -Average).Average
        $mem     = Get-CimInstance Win32_OperatingSystem
        $memFree = [math]::Round($mem.FreePhysicalMemory / 1024, 2)
    }
    catch {
        $cpuLoad = 0
        $memFree = 0
    }

    $state = [ordered]@{
        CPUUsage   = $cpuLoad
        MemoryFree = $memFree
        LogsCount  = (Get-ChildItem $LogsDir -Filter "*.log" -ErrorAction SilentlyContinue | Measure-Object).Count
        Time       = (Get-Date)
    }

    # Lecture des rapports r√©cents
    $report   = Get-Content (Join-Path $LogsDir "AthenaReport.log") -ErrorAction SilentlyContinue -Tail 50
    $repair   = Get-Content (Join-Path $LogsDir "AthenaRepair.log") -ErrorAction SilentlyContinue -Tail 50
    $learning = Get-Content (Join-Path $MemoryDir "LearningSummary.json") -ErrorAction SilentlyContinue | ConvertFrom-Json -ErrorAction SilentlyContinue

    $state["RecentReport"]  = ($report -join "`n")
    $state["RecentRepair"]  = ($repair -join "`n")
    $state["LearningScore"] = $learning.Score

    Write-CognitionLog "‚úÖ Donn√©es collect√©es : CPU=$([math]::Round($state.CPUUsage,2))% | RAM libre=$([math]::Round($state.MemoryFree,2)) MB"
    return $state
}

# =====================================================================
# üîπ RAISONNEMENT ET INTERPR√âTATION
# =====================================================================
function Invoke-AthenaReasoning {
    param([hashtable]$State)
    Write-CognitionLog "Analyse cognitive du contexte en cours..."
    try {
        $prompt = @"
Analyse les √©l√©ments suivants et produis une r√©flexion concise :
- Donn√©es syst√®me (CPU/RAM)
- Logs r√©cents d‚ÄôAthena
- Score d‚Äôapprentissage

Formate ta r√©ponse sous la forme :
Observation : ...
Hypoth√®se : ...
Action_sugg√©r√©e : ...
"@
        $prompt += "`n`nContexte : $($State | ConvertTo-Json -Depth 3 -Compress)"

        if (Get-Command Invoke-LocalModel -ErrorAction SilentlyContinue) {
            $response = Invoke-LocalModel -Prompt $prompt
        }
        else {
            $response = "Observation : LocalModel non disponible.`nHypoth√®se : moteur cognitif partiel.`nAction_sugg√©r√©e : ex√©cuter une v√©rification compl√®te."
        }

        Write-CognitionLog "üí≠ R√©flexion g√©n√©r√©e : $response"
        return $response
    }
    catch {
        Write-CognitionLog "‚ùå Erreur pendant le raisonnement : $_" "ERROR"
        return "Observation : Erreur cognitive`nHypoth√®se : Exception`nAction_sugg√©r√©e : Reprendre cycle."
    }
}

# =====================================================================
# üîπ SAUVEGARDE ET MISE √Ä JOUR DE LA CARTE COGNITIVE (corrig√©e)
# =====================================================================
function Update-CognitiveMap {
    param([string]$Response)
    try {
        $entry = @{
            Timestamp  = (Get-Date).ToString("s")
            Reflection = $Response
        }

        $existing = @()
if (Test-Path $CognitiveMap) {
    $raw = Get-Content $CognitiveMap -Raw -ErrorAction SilentlyContinue
    if ($raw.Trim().Length -gt 0) {
        try {
            $parsed = $raw | ConvertFrom-Json -ErrorAction Stop
            if ($parsed -is [System.Collections.IEnumerable]) {
                $existing += $parsed
            }
            else {
                $existing += ,$parsed
            }
        }
        catch {
            Write-CognitionLog "‚ö†Ô∏è Erreur lecture CognitiveMap, recr√©ation du fichier." "WARN"
        }
    }
}

$existing += $entry
        $existing | ConvertTo-Json -Depth 4 | Set-Content -Path $CognitiveMap -Encoding UTF8
        Write-CognitionLog "üß© CognitiveMap mise √† jour avec succ√®s."
    }
    catch {
        Write-CognitionLog "‚ùå Erreur mise √† jour CognitiveMap : $_" "ERROR"
    }
}

# =====================================================================
# üîπ D√âCISION ET ACTION
# =====================================================================
function Invoke-AthenaDecision {
    param([string]$Response)
    Write-CognitionLog "D√©cision bas√©e sur la r√©flexion en cours..."
    if ($Response -match "v√©rification" -or $Response -match "r√©paration") {
        if (Get-Command Invoke-ActionPlan -ErrorAction SilentlyContinue) {
            Invoke-ActionPlan -Plan "selfrepair"
            Write-CognitionLog "ü©∫ Action : auto-r√©paration d√©clench√©e."
        }
        else {
            Write-CognitionLog "‚ö†Ô∏è ActionEngine non disponible ‚Äì d√©cision enregistr√©e seulement." "WARN"
        }
    }
    elseif ($Response -match "stable" -or $Response -match "aucun probl√®me") {
        Write-CognitionLog "üòå Syst√®me stable ‚Äì aucune action corrective requise."
    }
    else {
        Write-CognitionLog "üìò Observation enregistr√©e pour apprentissage futur."
    }
}

# =====================================================================
# üîπ CYCLE COGNITIF COMPLET
# =====================================================================
function Invoke-AthenaCognition {
    Write-CognitionLog "üöÄ D√©marrage du cycle cognitif complet..."
    Initialize-Cognition
    $state      = Collect-AthenaState
    $reflection = Invoke-AthenaReasoning -State $state
    Update-CognitiveMap -Response $reflection
    Invoke-AthenaDecision -Response $reflection
    Write-CognitionLog "‚úÖ Cycle cognitif termin√© avec succ√®s."
}

Export-ModuleMember -Function *-Athena*, Initialize-Cognition, Write-CognitionLog, Update-CognitiveMap
# =====================================================================
# Fin du module Athena.Cognition.psm1
# =====================================================================















































