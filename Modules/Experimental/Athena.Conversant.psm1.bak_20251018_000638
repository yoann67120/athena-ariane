# ====================================================================
# üí¨ Athena.Conversant.psm1 ‚Äì Interface conversationnelle hybride
# Version : v3.6-AutoClean-Stable
# Auteur  : Ariane V4 / Athena Core Engine
# Objectif : conversation naturelle + ex√©cution intelligente des actions syst√®me
# ====================================================================

Set-StrictMode -Version Latest
$ErrorActionPreference = "SilentlyContinue"

# === Importations automatiques ===
$deps = @(
    "Athena.HybridCore.psm1",
    "Athena.Voice.psm1",
    "Athena.Sound.psm1",
    "ActionEngine.psm1",
    "AutoPatch.psm1"
)
foreach ($dep in $deps) {
    $path = Join-Path $PSScriptRoot $dep
    if (Test-Path $path) {
        Import-Module $path -Force -Global
    } else {
        Write-Warning "‚ö†Ô∏è D√©pendance manquante : $dep"
    }
}

# === Configuration m√©moire ===
$Root      = Split-Path -Parent $PSScriptRoot
$MemoryDir = Join-Path $Root "Memory"
if (!(Test-Path $MemoryDir)) { New-Item -ItemType Directory -Path $MemoryDir | Out-Null }
$ConvLog   = Join-Path $MemoryDir "Conversations.log"

# ====================================================================
# ‚ö° Analyse d‚Äôintention et ex√©cution d‚Äôaction
# ====================================================================
function Invoke-AthenaAction {
    param([string]$Text)

    $cmd = $Text.ToLower()
    switch -regex ($cmd) {

        # === Nouvelle intention : cr√©ation de module ===
        "cr√©e|creer|nouveau.?module|ajoute.?module|genere.?module" {
            Write-Host "üß© D√©tection d‚Äôune intention de cr√©ation de module..." -ForegroundColor Cyan
            if (Get-Command Invoke-AthenaVoice -ErrorAction SilentlyContinue) {
                try { Invoke-AthenaVoice -Text "Cr√©ation de module en cours..." -Silent } catch {}
            }

            $prompt = "$Text. R√©ponds uniquement avec le code PowerShell complet du module, sans explication ni commentaire."
            try {
                $response = Invoke-AthenaHybrid -Prompt $prompt
                Write-Host "üß† R√©ponse GPT Architecte re√ßue ‚Äì tentative d‚Äôapplication automatique..." -ForegroundColor Cyan

                # üßπ Nettoyage du code PowerShell (suppression des balises Markdown)
                if ($response -match '```powershell([\s\S]*?)```') { $response = $matches[1].Trim() }
                elseif ($response -match '```([\s\S]*?)```') { $response = $matches[1].Trim() }

                Apply-GPTCode -Code $response
                if (Get-Command Invoke-AthenaVoice -ErrorAction SilentlyContinue) {
                    try { Invoke-AthenaVoice -Text "Module g√©n√©r√© et charg√© avec succ√®s." -Silent } catch {}
                }
                return "‚úÖ Module g√©n√©r√© automatiquement par le GPT Architecte."
            }
            catch {
                Write-Warning "‚ö†Ô∏è Erreur durant la cr√©ation automatique de module : $_"
                if (Get-Command Invoke-AthenaVoice -ErrorAction SilentlyContinue) {
                    try { Invoke-AthenaVoice -Text 'Erreur lors de la g√©n√©ration du module.' -Silent } catch {}
                }
                return "‚ùå Erreur lors de la g√©n√©ration du module."
            }
        }

        # === Intentions standards ===
        "r√©pare|repare|auto.?repair|patch" { return Invoke-ActionPlan -Plan "AutoRepair" }
        "synchronis(e|er)|m√©moire|memoire" { return Invoke-ActionPlan -Plan "MemorySync" }
        "harmoni(e|e)|√©quilibre|equilibre" { return Invoke-ActionPlan -Plan "AutoHarmony" }
        "apprends|apprentissage|learning"  { return Invoke-ActionPlan -Plan "AutoLearning" }
        "rapport"                         { return Invoke-ActionPlan -Plan "AutoReport" }
        "√©volution|evolution"             { return Invoke-ActionPlan -Plan "AutoEvolution" }
        default                           { return $null }
    }
}

# ====================================================================
# üß† Moteur de conversation principale
# ====================================================================
function Invoke-AthenaConversant {
    Write-Host "`nüí¨ Mode conversation directe activ√©." -ForegroundColor Cyan
    Write-Host "Tape 'exit' pour quitter.`n" -ForegroundColor DarkGray

    while ($true) {
        $input = Read-Host "üó£Ô∏è Toi"
        if ($input -eq "exit") {
            Write-Host "`nüëã Fin de la session.`n" -ForegroundColor Yellow
            break
        }

        Add-Content -Path $ConvLog -Value ("[Toi] " + $input)

        try {
            # üß† Reformulation automatique pour GPT Architecte
            if ($input -match "cr√©e|creer|corrige|corriger|module|psm1|script|patch|code") {
                $input = "$input. R√©ponds uniquement avec le code PowerShell complet du module, sans explication ni commentaire."
                Write-Host "üß© Reformulation automatique pour GPT Architecte..." -ForegroundColor Cyan
            }

            $actionResult = Invoke-AthenaAction -Text $input
            if ($actionResult) { $response = $actionResult }
            else { $response = Invoke-AthenaHybrid -Prompt $input }
        }
        catch {
            $response = "‚ö†Ô∏è Erreur interne pendant la r√©ponse."
        }

        if ([string]::IsNullOrWhiteSpace($response)) { $response = "(aucune r√©ponse)" }
        Add-Content -Path $ConvLog -Value ("[Athena] " + $response)
        Write-Host "ü§ñ Athena : $response" -ForegroundColor Green

        if (Get-Command Invoke-AthenaVoice -ErrorAction SilentlyContinue) {
            try { Invoke-AthenaVoice -Text $response -Silent } catch {}
        }
    }
}

# ====================================================================
# üîß Export global
# ====================================================================
Export-ModuleMember -Function Invoke-AthenaConversant
Write-Host "‚úÖ Athena.Conversant.psm1 v3.6-AutoClean-Stable charg√© (cr√©ation automatique + nettoyage Markdown + feedback vocal)." -ForegroundColor Cyan



























